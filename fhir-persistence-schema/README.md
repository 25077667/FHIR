# IBM FHIR Server - fhir-persistence-schema

Builds and manages the multi-tenant FHIR R4 RDBMS schema (Db2). Includes Derby support for use in unit tests.

# Creating the database 

To create the database and database user, please use the following command.

``` shell 
useradd fhiruser
su - db2inst1 -c "db2 CREATE DB FHIRDB using codeset UTF-8 territory us PAGESIZE 32768"
su - db2inst1 -c "db2 \"connect to fhirdb\" && db2 \"grant connect on database TO USER fhiruser\""
```
# Printing the schema

To print the schema DDL for review, build the fhir-database-utils and fhir-persistence-schema jars and execute `com.ibm.fhir.schema.app.SchemaPrinter`:

``` shell 
java -cp ./fhir-database-utils.jar:fhir-persistence-schema.jar com.ibm.fhir.schema.app.SchemaPrinter [--to-file]
```

Without to-file, the output is the current System.out; else it's schema.sql, grants.sql, and stored-procedures.sql of the current directory.


# Deploy and manage the schema with `com.ibm.fhir.schema.app.Main` 

To deploy and manage the schema on a target database, the `fhir-persistence-schema` project includes a Main class that can parallelize the schema updates.

``` shell 
java -cp ./fhir-database-utils.jar:fhir-persistence-schema.jar com.ibm.fhir.schema.app.Main [OPTIONS]
```

The following sections include common values for `OPTIONS`:

## Drop tables from FHIR_ADMIN and FHIRDATA

```
--prop-file fhir.properties
--schema-name FHIRDATA
--drop-schema
--drop-admin
--confirm-drop
```

## Create new schema

```
--prop-file fhir.properties
--schema-name FHIRDATA
--create-schemas
```

## Deploy new schema

```
--prop-file fhir.properties
--schema-name FHIRDATA
--update-schema
```

## Add a new tenant (e.g. tenant1)

Don't forget to copy the tenant-key secret generated by --allocate-tenant. This key must be added to the datasource configuration to authorize the FHIR server to access this tenant.

```
--prop-file fhir.properties
--schema-name FHIRDATA
--allocate-tenant tenant1
```


## Grant privileges to data access user

```
--prop-file fhir.properties
--schema-name FHIRDATA
--grant-to FHIRSERVER
```

## Configure tenant-key (example)

Edit `wlp/usr/servers/fhir-server/config/tenant1/fhir-server-config.json` and add the tenant-key captured from the add-tenant step above:

```
                "default": {
                    "tenantKey": "<the-base64-tenant-key>",
                    "type": "db2",
                    "connectionProperties": {
                        "serverName": "<db2-host-name>",
                        "portNumber": 50001,
                        "databaseName": "BLUDB",
                        "apiKey": "<your-db2-api-key>",
                        "securityMechanism": 15,
                        "pluginName": "IBMIAMauth",
                        "currentSchema": "FHIRDATA",
                        "driverType": 4,
                        "sslConnection": true,
                        "sslTrustStoreLocation": "resources/security/dbTruststore.jks",
                        "sslTrustStorePassword": "<your-ssl-truststore-password>"
                    }
                }
```

## Test a tenant

```
--prop-file fhir-apikey.properties
--schema-name FHIRDATA
--test-tenant TNT1
--tenant-key "<the-base64-tenant-key>"
```

## Update the stored procedures for FHIRDATA (and not FHIR_ADMIN)

```
--prop-file config/fhir.properties
--schema-name FHIRDATA
--update-proc
```

# Alternative: manually apply the schema changes

To manually apply the DDL to a Db2 instance:
1. Print the schema to files by executing the SchemaPrinter:
    `java -cp ./fhir-database-utils.jar:fhir-persistence-schema.jar com.ibm.fhir.schema.app.SchemaPrinter --to-file`

2. Connect to your instance and execute each of the following:
    - schema.sql:  `db2 -tvf schema.sql`
    - grants.sql:  `db2 -tvf grants.sql`
    - stored-procedures.sql:  `db2 -td@ -vf stored-procedures.sql`


FHIRÂ® is the registered trademark of HL7 and is used with the permission of HL7.
